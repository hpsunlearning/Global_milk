---
title: "Beta diversity"
author: "Haipeng Sun"
date: "7/14/2022"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
library(knitr)
library(phyloseq)
library(usedist)
library(purrr)
library(furrr)
library(vegan)
library(ape)
library(rlist)
library(ggpubr)
library(ggtext)
library(glue)
library(tidyverse)
```

## load data
```{r}
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/phylo_meta.Rdata")
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/beta_DM_uu.RData")
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/beta_DM_wu.RData")
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/beta_DM_bray.RData")
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/beta_DM_jaccard.RData")
temp_out = "~/Dropbox/rutgers/20220606_RUN41_milk/Data/output/beta/"
```

## function
```{r}
calcOmega2_dm <- function(x) {
    # Computes the effect size omega^2 parital using the output from adonis test
    # Args:
    #   x: adonis output
    # Returns:
    #   A dataframe with calculated effect size omega^2 partial added to original dataframe
    require(dplyr)
    N_t = x["Total", ]$Df + 1
    MSe = x["Residual", ]$SumOfSqs/x["Residual", ]$Df
    out = x %>% as.data.frame %>% rownames_to_column(var = "Variable") %>% mutate(Omega2_partial = ifelse(is.na(`F`), NA, (SumOfSqs - Df * MSe)/(SumOfSqs + (N_t - Df) * MSe)))
    return(out)
}
```

## beta explore all 
```{r}
for(dd in c("uu","wu","bray","jaccard")){
  wdist <- get(paste0("DM_",dd))
  wmeta = meta_all %>% filter(SampleID %in% labels(wdist), !is.na(Country))
  wdist <- dist_subset(wdist, wmeta$SampleID)  
  ## dispersion of major variables
  disper <- betadisper(wdist, wmeta$Country)
  d1 <- (TukeyHSD(disper, which = "group"))$group %>% as.data.frame() %>% 
    rownames_to_column(var = "Variable")
  disper <- betadisper(wdist, wmeta$Extraction_method)
  d2 <- (TukeyHSD(disper, which = "group"))$group %>% as.data.frame() %>% 
    rownames_to_column(var = "Variable")
  disper <- betadisper(wdist, wmeta$heat_inactivated)
  d3 <- (TukeyHSD(disper, which = "group"))$group %>% as.data.frame() %>% 
    rownames_to_column(var = "Variable")
  disper <- betadisper(wdist, wmeta$Project)
  d4 <- (TukeyHSD(disper, which = "group"))$group %>% as.data.frame() %>% 
    rownames_to_column(var = "Variable")  
  write.csv(rbind(d1, d2, d3, d4), 
            file = paste0(temp_out,dd,"_","dispersion_test.csv"), quote = F, row.names = F)
  ## adonis of major variables
  per <- adonis2(wdist ~ PCRConc+heat_inactivated+Extraction_method+Country, 
                 data = wmeta, by = "margin")
  res = calcOmega2_dm(per)
  write.csv(res, 
            file = paste0(temp_out,dd,"_","adonis_test_overall.csv"), quote = F, row.names = F)
}
```

## beta in Global project
```{r}
meta <- phylo_decontam_clean_rf@sam_data@.Data %>% as.data.frame()
names(meta) <- phylo_decontam_clean_rf@sam_data@names
meta$SampleID <- phylo_decontam_clean_rf@sam_data@row.names

meta <- rbind(meta %>% filter(!is.na(Country), Project %in% c("Global", "Upside", "Milkbank")),
             meta %>% filter(!is.na(Country), Project  %in% c("Covid Mom", "Family", "PR")) %>%
               filter(TimePoint == 1200))

for(dd in c("uu","wu","bray","jaccard")){
  wdist <- get(paste0("DM_",dd))
  wmeta = meta %>% filter(SampleID %in% labels(wdist))
  wdist <- dist_subset(wdist, wmeta$SampleID)  
  #PCoA
  wrda <- dbrda(wdist ~ 1, sqrt.dist = TRUE)
  wrda_eig <- eigenvals(wrda)
  varPC1 <- round(wrda_eig["MDS1"]/sum(wrda_eig)*100,2)
  varPC2 <- round(wrda_eig["MDS2"]/sum(wrda_eig)*100,2)
  wdat_pcoa <- merge(scores(wrda, display = "sites", choices = c(1,2)),
                    wmeta, by.x = 0, by.y = "SampleID", all.x = T) %>% 
    rename(PC1 = MDS1, PC2 = MDS2)
  wrda_fit <- envfit(wrda ~ Country, data = wmeta)
  wdat_center <- wrda_fit$factors$centroids %>% as.data.frame() %>% 
    rownames_to_column(var = "Country") %>%
    transmute(Country = str_remove(Country,"Country"),PC1 = MDS1, PC2 = MDS2) %>%
    left_join(wmeta %>% select(Country, Continent) %>% unique(),by = "Country")
  wdat <- wdat_pcoa %>% left_join(wdat_center %>% transmute(PC1.c = PC1, PC2.c = PC2, Country), by = "Country")
  x_lab <- paste0("PC1 (", varPC1, "%)")
  y_lab <- paste0("PC2 (", varPC2, "%)")
  
  g <- ggplot(wdat, aes(x = PC1, y = PC2, color = Country)) + 
      geom_point(size = 2) + 
      scale_color_manual(values = Country_color) + 
      labs(x = x_lab, y = y_lab, title = "") +
      theme_bw() + theme(#aspect.ratio = 1,
                           panel.background = element_rect(fill = NA),
                           strip.text = element_text(size=12,color="black",face='bold'),
                           axis.title = element_text(size=12,color="black",face='bold'),
                           axis.text = element_text(size=12,color="black",face='bold'),
                           axis.text.x = element_text(size=12,color="black",face='bold'),
                           axis.text.y = element_text(size=12,color="black",face='bold'),
                           legend.text = element_text(size=12,color="black",face='bold'),
                           legend.title = element_text(size=12,color="black",face='bold'),
                           title = element_text(size=12,color="black",face='bold'))    
  ggsave(filename = paste0(temp_out,"PCoA_",dd,"_Global_by_country.pdf"), device = cairo_pdf, 
           plot = g, width = 7, height = 5, units = "in", dpi = 300)
  
  g <- ggplot(wdat_center, aes(x = PC1, y = PC2, color = Continent)) + 
    geom_point(data = wdat, aes(x = PC1, y = PC2, color = Continent), size = 1, alpha = 0.5) + 
    geom_segment(data = wdat, aes(x = PC1, y = PC2, xend = PC1.c, yend = PC2.c), size = 0.2, alpha = 0.5) + 
    geom_point(size = 4) + 
    geom_text_repel(aes(label = Country), color = "black") + 
    scale_color_manual(values = Continent_color) + 
    labs(x = x_lab, y = y_lab, title = "") +
    theme_bw() + theme(#aspect.ratio = 1,
                           panel.background = element_rect(fill = NA),
                           strip.text = element_text(size=12,color="black",face='bold'),
                           axis.title = element_text(size=12,color="black",face='bold'),
                           axis.text = element_text(size=12,color="black",face='bold'),
                           axis.text.x = element_text(size=12,color="black",face='bold'),
                           axis.text.y = element_text(size=12,color="black",face='bold'),
                           legend.text = element_text(size=12,color="black",face='bold'),
                           legend.title = element_text(size=12,color="black",face='bold'),
                           title = element_text(size=12,color="black",face='bold'))    
  ggsave(filename = paste0(temp_out,"PCoA_",dd,"_Global_by_country_center.pdf"), device = cairo_pdf, 
           plot = g, width = 7, height = 5, units = "in", dpi = 300)  
  #RDA    
  wrda2 <- dbrda(wdist ~ Country, sqrt.dist = TRUE, data = wmeta)
  wrda_eig <- eigenvals(wrda2)
  varRDA1 <- round(wrda_eig["dbRDA1"]/sum(wrda_eig)*100,2)
  varRDA2 <- round(wrda_eig["dbRDA2"]/sum(wrda_eig)*100,2)
  wrda_score <- scores(wrda2)
  wdat_rda <- merge(wrda_score$sites,
                    wmeta, by.x = 0, by.y = "SampleID", all.x = T)
  wdat_center <- wrda_score$centroids %>% as.data.frame() %>% 
    rownames_to_column(var = "Country") %>%
    transmute(Country = str_remove(Country,"Country"),dbRDA1, dbRDA2) %>%
    left_join(wmeta %>% select(Country, Continent) %>% unique(),by = "Country")
  wdat <- wdat_rda %>% left_join(wdat_center %>% transmute(dbRDA1.c = dbRDA1, dbRDA2.c = dbRDA2, Country), by = "Country")
  x_lab <- paste0("dbRDA1 (", varRDA1, "%)")
  y_lab <- paste0("dbRDA2 (", varRDA2, "%)")  
  
  g <- ggplot(wdat_center, aes(x = dbRDA1, y = dbRDA2, color = Continent)) + 
    geom_point(data = wdat, aes(x = dbRDA1, y = dbRDA2, color = Continent), size = 1, alpha = 0.5) + 
    geom_segment(data = wdat, aes(x = dbRDA1, y = dbRDA2, xend = dbRDA1.c, yend = dbRDA2.c), size = 0.2, alpha = 0.5) + 
    geom_point(size = 4) + 
    geom_text_repel(aes(label = Country), color = "black") + 
    scale_color_manual(values = Continent_color) + 
    labs(x = x_lab, y = y_lab, title = "") +
    theme_bw() + theme(#aspect.ratio = 1,
                           panel.background = element_rect(fill = NA),
                           strip.text = element_text(size=12,color="black",face='bold'),
                           axis.title = element_text(size=12,color="black",face='bold'),
                           axis.text = element_text(size=12,color="black",face='bold'),
                           axis.text.x = element_text(size=12,color="black",face='bold'),
                           axis.text.y = element_text(size=12,color="black",face='bold'),
                           legend.text = element_text(size=12,color="black",face='bold'),
                           legend.title = element_text(size=12,color="black",face='bold'),
                           title = element_text(size=12,color="black",face='bold'))    
  ggsave(filename = paste0(temp_out,"dbRDA_",dd,"_Global_by_country_center.pdf"), device = cairo_pdf, 
           plot = g, width = 7, height = 5, units = "in", dpi = 300)
}
```





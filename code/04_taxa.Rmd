---
title: "Taxa"
author: "Haipeng Sun"
date: "8/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## library
```{r message=FALSE, warning=FALSE, include=FALSE}
library(phyloseq)
library(Hmisc)
library(agricolae)
library(grid)
library(gridExtra)
library(gtable)
library(ggrepel)
library(phyloseq)
library(usedist)
library(purrr)
library(furrr)
library(rlist)
library(ggpubr)
library(ggtext)
library(glue)
library(gplots)
library(ggpattern)
library(UpSetR)
library(RColorBrewer)
library(randomcoloR)
library(patchwork)
library(tidyverse)
```

## load data
```{r}
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/phylo_meta.Rdata")
temp_out = "~/Dropbox/rutgers/20220606_RUN41_milk/Data/output/taxa/"
```

## Global samples
```{r eval=FALSE, include=TRUE}
meta_global <- phylo_decontam_clean_rf@sam_data@.Data %>% as.data.frame()
names(meta_global) <- phylo_decontam_clean_rf@sam_data@names
meta_global$SampleID <- phylo_decontam_clean_rf@sam_data@row.names
meta_global <- rbind(meta_global %>% filter(!is.na(Country), Project %in% c("Global", "Upside", "Milkbank")),
                     #meta_global %>% filter(!is.na(Country), Project  %in% c("Covid Mom", "Family", "PR")) %>%
                     meta_global %>% filter(!is.na(Country), Project=="PR") %>%
               filter(TimePoint == 1200))

phylo_global <- prune_samples(meta_global$SampleID, phylo_decontam_clean_rf)
phylo_global_s <- tax_glom(phylo_global, taxrank = "Species", NArm=FALSE)
phylo_global_g <- tax_glom(phylo_global, taxrank = "Genus", NArm=FALSE)
phylo_global_f <- tax_glom(phylo_global, taxrank = "Family", NArm=FALSE)
phylo_global_p <- tax_glom(phylo_global, taxrank = "Phylum", NArm=FALSE)

save(meta_global, phylo_global, phylo_global_s, phylo_global_g, phylo_global_f,phylo_global_p,
     file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/phylo_global.Rdata")
load(file = "~/Dropbox/Rutgers/20220606_RUN41_milk/Data/phylo_global.Rdata")
#rm(phylo_all, phylo_decontam, phylo_decontam_clean, phylo_decontam_clean_rf)
```

## unique ASV/species/genus in different Country (Global Project)
```{r}
for (taxrank in c("ASV","Species","Genus", "Family")){
  if (taxrank == "ASV"){
    ft <- otu_table(phylo_global@otu_table) %>% as.data.frame() %>% t()
  }else if(taxrank == "Species"){
    ft <- otu_table(phylo_global_s@otu_table) %>% as.data.frame() %>% t()
  }else if(taxrank == "Genus"){
    ft <- otu_table(phylo_global_g@otu_table) %>% as.data.frame() %>% t()
  }else{
    ft <- otu_table(phylo_global_f@otu_table) %>% as.data.frame() %>% t()
  }
  ft <- ft[meta_global$SampleID,]
  asv_sum_country <- aggregate(ft, by = list(meta_global$Country), sum)
  asv_sum_country_lst <- split(asv_sum_country[,-1], asv_sum_country[,1])
  asv_lst <- lapply(asv_sum_country_lst, function(dat){
    names(dat)[(which(dat[1,] > 1))]
  })
  g <- upset(fromList(asv_lst), 
           sets = c("Guinea Ecuatorial", "Kenya", "Senegal", "South Sudan", "Tanzania",
                    "Ecuador", "ElSalvador", "Mexico", "Peru", "Puerto Rico", "United States",
                    "Austria", "Germany", "Netherlands", "Norway", "Spain"),
           order.by = "freq", keep.order = TRUE,
      nsets = length(asv_lst),
      nintersects = 40)  
  pdf(file = paste0(temp_out,"rarefied_sharing_", taxrank, ".pdf"), 
      width = 9, height = 7, useDingbats = F)
  print(g)
  dev.off() 
}

```

## taxa plots
### phylums by country pie
```{r}
ft <- otu_table(phylo_global_p@otu_table) %>% as.data.frame() %>% t()
ft <- ft[meta_global$SampleID,]

ft_ra <- ft/rowSums(ft)
ft_ra_country <- aggregate(ft_ra, by = list(meta_global$Country), mean) %>%
  rename(Country = Group.1)

res <-  purrr::map_dfr(
    ft_ra_country %>% dplyr::select(-Country) %>% split(ft_ra_country$Country),
    function(dat){
      dat2 <- t(dat) %>% as.data.frame()
      names(dat2) <- "RA"
      dat3 <- dat2 %>% arrange(desc(RA)) %>% filter(RA > 0.01) %>% 
        rownames_to_column(var = "id")
      rbind(dat3, data.frame(id = "Other", RA = 1-sum(dat3$RA)))
      }, .id = "Country")

res <- res %>% left_join(taxa %>% select(id, Phylum), by = "id") %>% 
  mutate(Taxa = ifelse(is.na(Phylum),"Other",Phylum))

temp <- res %>% select(Taxa, RA) %>% group_by(Taxa) %>% dplyr::summarise(RA = mean(RA)) %>% arrange(desc(RA)) %>% filter(Taxa != "Other")


col_vector = c(brewer.pal(12, "Set3"), brewer.pal(12, "Paired"), 
               brewer.pal(8, "Set2"), brewer.pal(7, "Accent"))
phylum_color = c(col_vector[1:(nrow(temp))],"Gray50")
names(phylum_color) = c(temp$Taxa, "Other")

#g <- ggplot(res, aes(x = "", y = RA, fill = Taxa)) + 
#  geom_bar(stat = "identity", width = 1, color = "white") + 
#  scale_fill_manual(values = phylum_color, name = "") + 
#  coord_polar("y", start=0) + 
#  facet_wrap(~Country) + 
#  theme_void() + theme(strip.text = element_text(face = "bold", size = 12)) 
#ggsave(filename = paste0(temp_out,"top_phylum_pie.pdf"), device = cairo_pdf,
#       plot = g, width = 14, height = 10, units = "in", dpi = 300)

g_lst <- lapply(res$Country %>% unique(), function(x){
  g <- ggplot(res %>% filter(Country == x),
              aes(x = "", y = RA, fill = Taxa)) + 
    geom_bar(stat = "identity", width = 1, color = "white") + 
    scale_fill_manual(values = phylum_color, name = "") + 
    labs(title = x) + 
    coord_polar("y", start=0) + 
    theme_void() + theme(plot.title = element_text(face = "bold", size = 12, hjust = 0.5))  
})
names(g_lst) <- res$Country %>% unique()

#layout <- "
#ABCDE#
#FGHIJK
#LMNOPQ
#"
#g <- g_lst$`Guinea Ecuatorial` + g_lst$Kenya + g_lst$Senegal + g_lst$`South Sudan` + g_lst$Tanzania +
#  g_lst$Ecuador + g_lst$ElSalvador + g_lst$Mexico + g_lst$Peru + g_lst$`Puerto Rico` + g_lst$`United States` + 
#  g_lst$Austria + g_lst$Germany + g_lst$Netherlands + g_lst$Norway + g_lst$Spain + guide_area() + 
#  plot_layout(design = layout, guides = "collect")

g <- g_lst$`Guinea Ecuatorial` + g_lst$Kenya + g_lst$Senegal + g_lst$`South Sudan` + g_lst$Tanzania +
  g_lst$Ecuador + g_lst$ElSalvador + g_lst$Mexico + g_lst$Peru + g_lst$`Puerto Rico` + g_lst$`United States` + 
  g_lst$Austria + g_lst$Germany + g_lst$Netherlands + g_lst$Norway + g_lst$Spain + 
  plot_layout(ncol = 4, guides = "collect")
ggsave(filename = paste0(temp_out,"top_phylum_pie.pdf"), device = cairo_pdf,
       plot = g, width = 14, height = 10, units = "in", dpi = 300)
```

### taxa by country bar
```{r}
col_vector = c(brewer.pal(12, "Set3"), brewer.pal(12, "Paired"), 
               brewer.pal(8, "Set2"), brewer.pal(7, "Accent"))

for (taxrank in c("Species","Genus", "Family", "Phylum")){
  if(taxrank == "Species"){
    ft <- otu_table(phylo_global_s@otu_table) %>% as.data.frame() %>% t()
    top = 10
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Genus,Species, sep = ";"))
  }else if(taxrank == "Genus"){
    ft <- otu_table(phylo_global_g@otu_table) %>% as.data.frame() %>% t()
    top = 10
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Family,Genus, sep = ";"))
  }else if(taxrank == "Family"){
    ft <- otu_table(phylo_global_f@otu_table) %>% as.data.frame() %>% t()
    top = 10
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Order,Family, sep = ";"))
  }else{
    ft <- otu_table(phylo_global_p@otu_table) %>% as.data.frame() %>% t()
    top = 5
    taxa_temp <- taxa %>% mutate(taxa_long = Phylum)
  }

ft <- ft[meta_global$SampleID,]
ft_ra <- ft/rowSums(ft)
ft_ra_country <- aggregate(ft_ra, by = list(meta_global$Country), mean) %>%
  rename(Country = Group.1)

res <-  purrr::map_dfr(
    ft_ra_country %>% dplyr::select(-Country) %>% split(ft_ra_country$Country),
    function(dat){
      dat2 <- t(dat) %>% as.data.frame()
      names(dat2) <- "RA"
      dat3 <- dat2 %>% arrange(desc(RA)) %>% top_n(10, RA) %>% 
        filter(RA > 0.01) %>%
        rownames_to_column(var = "id")
      rbind(dat3, data.frame(id = "Other", RA = 1-sum(dat3$RA)))
      }, .id = "Country")

res <- res %>% left_join(taxa_temp, by = "id") %>% 
  mutate(Taxa = ifelse(is.na(taxa_long),"Other",taxa_long))

temp <- res %>% select(Taxa, RA) %>% group_by(Taxa) %>% dplyr::summarise(RA = mean(RA)) %>% arrange(desc(RA)) %>% filter(Taxa != "Other")

taxa_color <- c(col_vector[1:(nrow(temp))],"Gray50")
names(taxa_color) <- c(temp$Taxa, "Other")

g <- ggplot(res %>% mutate(Taxa =  factor(Taxa, levels = names(taxa_color), ordered = T),
                          Country = factor(Country, levels = names(Country_color), ordered = T)), 
           aes(Country, RA, fill = Taxa)) + 
  geom_bar(stat="identity") + 
  labs(x = "", y = "Mean Relative Abundance") + 
  scale_fill_manual(values = taxa_color, name="") + 
  scale_y_continuous(expand=c(0,0)) + 
  guides(fill = guide_legend(ncol = 1)) +
  theme_bw() + theme(aspect.ratio = 1.5,
                     panel.background = element_rect(fill = NA),
                     panel.border = element_blank(),
                     panel.grid = element_blank(),
                     axis.line = element_blank(),
                     axis.ticks = element_blank(),
                     axis.text = element_text(size=12,color="black",face='bold'),
                     axis.text.x = element_text(size=12,color="black",face='bold',
                                                angle=90, hjust = 1, vjust = 0.5),
                     axis.title = element_text(size=12,color="black",face='bold'),
                     legend.text = element_text(size=10,color="black",face='bold'))
ggsave(filename = paste0(temp_out,"top_", taxrank, "_bar.pdf"), device = cairo_pdf,
       plot = g, width = 14, height = 12, units = "in", dpi = 300)

Country_ord = res %>% filter(id == res$id[1]) %>% arrange(desc(RA)) %>% pull(Country)
g <- ggplot(res %>% mutate(Taxa =  factor(Taxa, levels = names(taxa_color), ordered = T),
                          Country = factor(Country, levels = Country_ord, ordered = T)), 
           aes(Country, RA, fill = Taxa)) + 
  geom_bar(stat="identity") + 
  labs(x = "", y = "Mean Relative Abundance") + 
  scale_fill_manual(values = taxa_color, name="") + 
  scale_y_continuous(expand=c(0,0)) + 
  scale_x_discrete(labels=Country_labels) + 
  guides(fill = guide_legend(ncol = 1)) +
  theme_bw() + theme(aspect.ratio = 1.5,
                     panel.background = element_rect(fill = NA),
                     panel.border = element_blank(),
                     panel.grid = element_blank(),
                     axis.line = element_blank(),
                     axis.ticks = element_blank(),
                     axis.text = element_text(size=12,color="black",face='bold'),
                     axis.text.x = element_markdown(size=12,color="black",face='bold',
                                                angle=90, hjust = 1, vjust = 0.5),
                     axis.title = element_text(size=12,color="black",face='bold'),
                     legend.text = element_text(size=10,color="black",face='bold'))
ggsave(filename = paste0(temp_out,"top_", taxrank, "_bar_sorted.pdf"), device = cairo_pdf,
       plot = g, width = 14, height = 12, units = "in", dpi = 300)
}
```

## taxa prevalence
```{r}
for (taxrank in c("ASV", "Species","Genus", "Family", "Phylum")){
  if(taxrank == "ASV"){
    ft <- otu_table(phylo_global@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Genus,Species,ASV, sep = ";"))
  }else if(taxrank == "Species"){
    ft <- otu_table(phylo_global_s@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Genus,Species, sep = ";"))
  }else if(taxrank == "Genus"){
    ft <- otu_table(phylo_global_g@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Family,Genus, sep = ";"))
  }else if(taxrank == "Family"){
    ft <- otu_table(phylo_global_f@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Order,Family, sep = ";"))
  }else{
    ft <- otu_table(phylo_global_p@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = Phylum)
  }
  n = length(phylo_global@sam_data@row.names)
  ft2 <- t(ft)
  ft <- ft[rowSums(ft)>0, ]
  ft <- ft/colSums(ft)[1]
  dat <- data.frame(id = rownames(ft), prevalence = rowSums(ft>0)/n*100, abundance =  rowMeans(ft))
  dat <- dat %>% left_join(taxa, by = "id")
  ft2 <- ft2[meta_global$SampleID,]
  asv_sum_country <- aggregate(ft2, by = list(meta_global$Country), sum)
  asv_sum_country_lst <- split(asv_sum_country[,-1], asv_sum_country[,1])
  asv_lst <- lapply(asv_sum_country_lst, function(dat){
    names(dat)[(which(dat[1,] > 1))]
  })
  universal_id <- Reduce(intersect, asv_lst)
  dat <- dat %>% mutate(Universal = ifelse(id %in% universal_id, "Y", "N"))
  write.csv(dat, file = paste0(temp_out,"Prevalence_", taxrank, "_in_global.csv"), row.names = F, quote = F)
}










```

## heatmap from high prevalence abundance taxa
```{r}
for (taxrank in c("ASV", "Species","Genus", "Family", "Phylum")){
  if(taxrank == "ASV"){
    ft <- otu_table(phylo_global@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Genus,Species,ASV, sep = ";"))
  }else if(taxrank == "Species"){
    ft <- otu_table(phylo_global_s@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Genus,Species, sep = ";"))
  }else if(taxrank == "Genus"){
    ft <- otu_table(phylo_global_g@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Family,Genus, sep = ";"))
  }else if(taxrank == "Family"){
    ft <- otu_table(phylo_global_f@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = str_c(Order,Family, sep = ";"))
  }else{
    ft <- otu_table(phylo_global_p@otu_table) %>% as.data.frame()
    taxa_temp <- taxa %>% mutate(taxa_long = Phylum)
  }
  dat <- read_csv(paste0(temp_out,"Prevalence_", taxrank, "_in_global.csv"))
  select_id <- dat %>% filter(prevalence>50 | abundance > 0.01) %>% pull(id)
  ft <- ft[rowSums(ft)>0, ]
  wft <- ft[select_id, meta_global %>% pull(SampleID)]
  if (nrow(wft)>50){
    wft <- wft[(rowSums(wft) %>% sort(.,decreasing = T))[1:50] %>% names(),]
  }
  wft <- log10((wft + 0.5)/colSums(ft)[1])
  wft <- wft %>% rownames_to_column(var="id") %>% left_join(taxa_temp %>% dplyr::select(id, taxa_long), by = "id") %>% 
  dplyr::select(-id) %>% dplyr::select(taxa_long, everything())
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}





```








